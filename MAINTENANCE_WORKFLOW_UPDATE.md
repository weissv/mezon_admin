# Обновление системы заявок на выдачу

Это обновление переработало систему заявок с внедрением workflow одобрения по ролям.

## Что изменилось

### 1. База данных
- **Новые статусы заявок**:
  - `PENDING` - Ожидает одобрения (заменяет старый статус NEW)
  - `APPROVED` - Одобрена (доступна Завхозу)
  - `REJECTED` - Отклонена
  - `IN_PROGRESS` - В работе (у Завхоза)
  - `DONE` - Выполнена

- **Новые поля**:
  - `approvedById` - ID сотрудника, одобрившего заявку
  - `approvedAt` - Дата и время одобрения
  - `rejectionReason` - Причина отклонения (если отклонена)

### 2. Workflow одобрения

#### Роли и права доступа:

**РАЗРАБОТЧИК (DEVELOPER)**
- Видит ВСЕ заявки
- Может создавать, редактировать, удалять любые заявки
- Может одобрять/отклонять любые заявки

**ДИРЕКТОР (DIRECTOR)**
- Видит заявки от всех ролей КРОМЕ учителей
- Видит свои собственные заявки
- Может одобрять/отклонять заявки от не-учителей
- НЕ МОЖЕТ одобрять заявки учителей (это делает Завуч)

**ЗАВУЧ (DEPUTY)**
- Видит заявки ТОЛЬКО от учителей
- Видит свои собственные заявки
- Может одобрять/отклонять только заявки учителей
- НЕ МОЖЕТ одобрять заявки от других ролей (это делает Директор)

**ЗАВХОЗ (ZAVHOZ)**
- Видит ТОЛЬКО одобренные заявки (статус: APPROVED, IN_PROGRESS, DONE)
- НЕ видит заявки в статусе PENDING или REJECTED
- Может изменять статус одобренных заявок (IN_PROGRESS → DONE)
- Может редактировать заявки в работе

**УЧИТЕЛЯ (TEACHER)**
- Видят ТОЛЬКО свои заявки
- Могут создавать новые заявки
- Могут редактировать свои заявки ДО одобрения
- НЕ МОГУТ редактировать после статуса APPROVED

**ADMIN**
- Полный доступ ко всем заявкам (как DEVELOPER)

### 3. API Endpoints

Добавлены новые эндпоинты:

```
POST /api/maintenance/:id/approve - Одобрить заявку
POST /api/maintenance/:id/reject  - Отклонить заявку (с указанием причины)
```

### 4. Frontend изменения

- Обновлены типы TypeScript для новых статусов и полей
- Добавлены модальные окна для одобрения/отклонения
- Адаптивная статистика в зависимости от роли:
  - Для Директора/Завуча: показывается "Ожидают одобрения"
  - Для Завхоза: "Одобренные" отображаются как "Новые"
- Кнопки действий отображаются в зависимости от прав доступа
- Колонка "Одобрил" показывается только для ролей с правами одобрения

## Применение изменений

### Шаг 1: Запустите Docker контейнеры
```bash
docker-compose up -d
```

### Шаг 2: Примените миграцию базы данных
```bash
cd backend
npx prisma migrate deploy
```

Или с помощью docker:
```bash
docker-compose exec backend npx prisma migrate deploy
```

### Шаг 3: Перезапустите приложение
```bash
docker-compose restart backend frontend
```

## Тестирование

1. **Тест Учителя**:
   - Войдите как учитель
   - Создайте заявку на выдачу
   - Убедитесь, что заявка имеет статус "Ожидает одобрения"
   - Попробуйте изменить заявку (должно быть возможно)

2. **Тест Завуча**:
   - Войдите как завуч
   - Проверьте, что видны только заявки от учителей
   - Одобрите одну заявку
   - Попробуйте одобрить заявку от директора (должна быть ошибка)

3. **Тест Директора**:
   - Войдите как директор
   - Проверьте, что видны заявки от всех КРОМЕ учителей
   - Одобрите заявку
   - Попробуйте одобрить заявку от учителя (должна быть ошибка)

4. **Тест Завхоза**:
   - Войдите как завхоз
   - Проверьте, что видны только одобренные заявки
   - Измените статус на "В работе"
   - Измените статус на "Выполнено"
   - Убедитесь, что заявки в статусе PENDING не отображаются

5. **Тест Разработчика**:
   - Войдите как разработчик
   - Проверьте, что видны ВСЕ заявки
   - Попробуйте все операции (создание, редактирование, удаление, одобрение, отклонение)

## Откат изменений

Если что-то пошло не так, вы можете откатить миграцию:

```bash
cd backend
npx prisma migrate resolve --rolled-back 20250112000000_update_maintenance_requests_workflow
```

Затем восстановите предыдущее состояние schema.prisma из git:
```bash
git checkout HEAD~1 -- backend/prisma/schema.prisma
git checkout HEAD~1 -- backend/src/routes/maintenance.routes.ts
git checkout HEAD~1 -- backend/src/schemas/maintenance.schema.ts
git checkout HEAD~1 -- frontend/src/pages/MaintenancePage.tsx
```

## Заметки

- Все существующие заявки со статусом NEW автоматически конвертируются в PENDING
- Права доступа основаны на роли пользователя в системе
- Workflow одобрения обязательный - заявки не могут попасть к Завхозу без одобрения
