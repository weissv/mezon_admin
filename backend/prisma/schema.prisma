
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Роли пользователей. Права описаны в middleware checkRole.
enum Role {
  DIRECTOR
  DEPUTY
  ADMIN
  TEACHER
  ACCOUNTANT
}

enum ChildStatus {
  ACTIVE
  LEFT
}

enum ClubEnrollmentStatus {
  ACTIVE
  WAITING_LIST
  CANCELLED
}

enum FinanceType {
  INCOME
  EXPENSE
}

enum FinanceCategory {
  NUTRITION
  CLUBS
  MAINTENANCE
  SALARY
}

enum InventoryType {
  FOOD
  SUPPLIES
}

enum MaintenanceStatus {
  NEW
  IN_PROGRESS
  DONE
}

enum MaintenanceType {
  REPAIR
  PURCHASE
}

model User {
  id           Int     @id @default(autoincrement())
  email        String  @unique
  passwordHash String
  role         Role
  employeeId   Int     @unique
  employee     Employee @relation(fields: [employeeId], references: [id])

  actionLogs   ActionLog[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Employee {
  id                   Int       @id @default(autoincrement())
  firstName            String
  lastName             String
  middleName           String?
  position             String
  rate                 Float     // ставка (можно Decimal, если нужна точность)
  hireDate             DateTime
  fireDate             DateTime?
  contractEndDate      DateTime?
  medicalCheckupDate   DateTime?
  attestationDate      DateTime?
  branchId             Int
  branch               Branch    @relation(fields: [branchId], references: [id])

  user                 User?
  clubs                Club[]        @relation("TeacherClubs")
  maintenanceRequests  MaintenanceRequest[]
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([branchId])
}

model Child {
  id         Int        @id @default(autoincrement())
  firstName  String
  lastName   String
  birthDate  DateTime
  groupId    Int
  group      Group      @relation(fields: [groupId], references: [id])
  healthInfo String?
  status     ChildStatus @default(ACTIVE)
  documents  Json?

  enrollments ClubEnrollment[]
  attendance  Attendance[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([groupId])
}

model Group {
  id       Int     @id @default(autoincrement())
  name     String
  branchId Int
  branch   Branch  @relation(fields: [branchId], references: [id])

  children Child[]

  @@index([branchId])
  @@unique([name, branchId]) // Название группы уникально в филиале
}

model Club {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  teacherId   Int
  teacher     Employee @relation("TeacherClubs", fields: [teacherId], references: [id])
  schedule    Json?    // [{day: "Monday", time: "16:00"}]
  cost        Decimal  @db.Decimal(12,2)
  maxStudents Int

  enrollments ClubEnrollment[]
  attendance  Attendance[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([teacherId])
  @@unique([name, teacherId]) // Уникальность кружка по имени у конкретного педагога
}

model ClubEnrollment {
  id       Int   @id @default(autoincrement())
  childId  Int
  clubId   Int
  status   ClubEnrollmentStatus @default(ACTIVE)

  child    Child @relation(fields: [childId], references: [id])
  club     Club  @relation(fields: [clubId], references: [id])
  createdAt DateTime @default(now())

  @@unique([childId, clubId]) // Один ребёнок — одна активная запись в кружок
  @@index([clubId])
  @@index([childId])
}

model Attendance {
  id        Int      @id @default(autoincrement())
  date      DateTime
  childId   Int
  clubId    Int?     // null — посещаемость по основной группе (не кружок)
  isPresent Boolean

  child     Child    @relation(fields: [childId], references: [id])
  club      Club?    @relation(fields: [clubId], references: [id])

  @@unique([date, childId, clubId]) // Уникальная отметка на дату/ребёнка/кружок
  @@index([childId])
  @@index([clubId])
}

model FinanceTransaction {
  id          Int            @id @default(autoincrement())
  amount      Decimal        @db.Decimal(14,2)
  type        FinanceType
  category    FinanceCategory
  description String?
  date        DateTime
  documentUrl String?

  createdAt   DateTime @default(now())
  @@index([type, category, date])
}

model InventoryItem {
  id         Int          @id @default(autoincrement())
  name       String
  quantity   Float        // Можно Decimal, если нужна высокая точность
  unit       String       // "кг", "шт"
  expiryDate DateTime?
  type       InventoryType

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([type, expiryDate])
}

model Menu {
  id       Int      @id @default(autoincrement())
  date     DateTime
  ageGroup String
  meals    Json     // [{name: "Завтрак", dish: "Каша", calories: 200}]

  @@unique([date, ageGroup])
  @@index([date])
}

model MaintenanceRequest {
  id          Int              @id @default(autoincrement())
  title       String
  description String?
  requesterId Int
  requester   Employee         @relation(fields: [requesterId], references: [id])
  status      MaintenanceStatus @default(NEW)
  type        MaintenanceType

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([requesterId, status, type])
}

model SecurityLog {
  id          Int      @id @default(autoincrement())
  eventType   String   // "Проверка ПБ", "Инцидент"
  description String?
  date        DateTime
  documentUrl String?

  createdAt   DateTime @default(now())
  @@index([date, eventType])
}

model Branch {
  id      Int     @id @default(autoincrement())
  name    String
  address String

  employees Employee[]
  groups    Group[]

  @@unique([name])
}

model ActionLog {
  id        Int     @id @default(autoincrement())
  userId    Int
  user      User    @relation(fields: [userId], references: [id])
  action    String  // "CREATE_CHILD" и т.п.
  details   Json?
  timestamp DateTime @default(now())

  @@index([userId, action, timestamp])
}
